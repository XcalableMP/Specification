\chapter{DRAFT: Coarray Features}
\label{chap:DRAFT: Coarray Features}

%-------------------------------------------------------%
% ENVIRONMENT 
%-------------------------------------------------------%
\newcommand{\onlyF}{{\tt [F]}} 
\newcommand{\onlyC}{{\tt [C]}} 

\newenvironment{Constraints}{\subsubsection*{Constraints}
 \begin{enumerate}}{\end{enumerate}}
\newenvironment{Constraints F}{\subsubsection*{Constraints {\onlyF}}
 \begin{enumerate}}{\end{enumerate}}
\newenvironment{Constraints C}{\subsubsection*{Constraints {\onlyC}}
 \begin{enumerate}}{\end{enumerate}}

\newenvironment{Restriction}{\subsubsection*{Restriction}
 \begin{itemize}}{\end{itemize}}

\newcommand{\NEW}[1]{\mytextcolor{red}{#1}}

%-------------------------------------------------------%
% PREFACE
%-------------------------------------------------------%

\framebox[0.9\textwidth][c]{
\rule[-5mm]{0mm}{10mm}
This chapter is a proposal document to be added before 
Section~\ref{chap:Support for the Local-view Programming}.
}

\bigskip


%-- COARRAY AS THE LOCAL-VIEW
For the local-view programming, {\XMP} supports the coarray features
as a part of the language specifications.
%-- SPECIFICATION RANGE OF THE XMP COARRAY
{\XMPF} contains all coarray features defined in the standard Fortran~2008
(ISO/IEC 1539-1:2010) with few incompatibility described in 
Section~\ref{sec:Compatibility with the Fortran Standard}
and includes some important intrinsic procedures defined in 
the standard Fortran~2015.
Also {\XMPC} contains the coarray features which was designed based on
the ones of {\XMPF}.


%-------------------------------------------------------%
\section{Introduction for Coarrays}
\label{sec:Introduction for Coarrays}
%-------------------------------------------------------%

\subsubsection*{Image and image index}
The local-view programming model is a Single Program Multiple Data (SPMD) model.
Each replication of the program is called an {\bf image}.
The images are mapped one-by-one to the execution nodes.
The correspondence between images and nodes is defined in 
Chapter~\ref{chap:Interoperability of Global- and Local-views}.

Each image has a unique number that is called {\bf image index}. 
Image indices are consecutive and start from one.
The number of images is fixed at the begining of the program execution.
The image index and the number of images can be inquired with the intrinsic
functions described in Section~\ref{sec:Intrinsic Procedures}.

\subsubsection*{Coarrays}
A \NEW{\bf coarray} is a named or unnamed variable that is allowed to be referred 
by the other images. 
A coarray is either a {\bf scalar coarray} or an {\bf array coarray}.

{\onlyF}
A coarray has either an intrinsic type or a derived type.

{\onlyC}
A scalar coarray shall be a coarray of a basic type or a {\tt struct} type.
An array coarray shall be a coarray of an array type.
A {\bf coarray pointer} shall be a pointer to a coarray.\footnote
{A coarray pointer is not a coarray. 
The target of a coarray pointer is an unnamed coarray.}

\subsubsection*{Attributes of coarray}
A coarray and a coarray pointer are declared with a coarray specifier ({\it coarray-spec}) 
that describes a virtual array of images
corresponding to the coarray and to the target coarray of the coarray pointer,
respectively.
The shape of the virtual array of images is called a {\bf coshape}.

A {\bf corank} is the number of the dimensions of a coshape.
The corank is defined as 0 for a non-coarray variable.
%
A {\bf coextent} is the extent of a dimension of a coshape.
Each coextent must be a positive number.
The coextent of the final dimension is determined at enter of the 
program execution.
%
Lower and upper {\bf cobounds} are the lower and upper bounds of a
dimension of the virtual array of images, respectively. 


\subsubsection*{Static and allocatable coarrays}
A coarray is either a \NEW{\bf static coarray} or an \NEW{\bf allocatable coarray}.
%
A static coarray is declarad with an explicit specification of the coshape.
If it is a dummy argument, the coshape is redefined by the specification during 
the execution in the scope.
%
An allocatable coarray is declared with an deferred specification of the coshape.
which are determined when the data object is allocated.
If it is a dummy argument, the coshape is inherited from the actural argument.

{\onlyF} 
A static coarray does not have the ALLOCATABLE attribute.
A procedure-local static coarray must have the SAVE attribute 
unless it is a dummy argument.
An allocatable coarray has the ALLOCATABLE attribute.

{\onlyC} 
A static coarray is of a basic type, a {\tt struct} type, or an array.
An allocatable coarray is not a named variable and the target of a coarray pointer.
Intrinsic function {\tt xmp\_coarray\_malloc} allocates an allocatable coarray,
determines the coextents, and returns the address to be assigned to the coarray pointer.


**************************************************


\subsubsection*{Cosubscript}
A coarray variable addressed on the different image can be 
referenced and defined with the {\bf cosubscripts} that identifies the image index.
See Section~\ref{sec:Allocation and Deallocation of Coarrays} for the detail.

\subsubsection*{Coarray container}
{\onlyF}
A derived type that has a scalar coarray component is called 
a \NEW{\bf coarray container type}.
A derived type that has a scalar component of a coarray container type 
is also called a coarray container type.
A scalar object of a coarray container type is called 
a \NEW{\bf coarray container}.

{\onlyC}
A {\tt struct} type that has a coarray component is called 
a \NEW{\bf coarray container type}.
A {\tt struct} type that has a component of a coarray container type 
is also called a coarray container type.
A object of a coarray container type is called 
a \NEW{\bf coarray container}.

\subsubsection*{Example}
TBD\\
Use example in email for coarray container.


\input{ch-co-decl}

%-------------------------------------------------------%
\section{Coarray Components}
\label{sec:Coarray Components}
%-------------------------------------------------------%

\begin{Constraints F}
\item A coarray container shall be a dummy argument or have 
the ALLOCATABLE or SAVE attribute.\footnote
{In other words, a local coarray container to the procedure should be a SAVE'd or 
allocatable structure unless it is a dummy argument.}

\item A coarray container shall be a nonpointer nonallocatable scalar, 
shall not be a coarray, and shall not be a function result. 
\end{Constraints F}

\begin{Constraints C}
\item A coarray container shall be a dummy argument or have the {\tt static} 
or {\tt extern} storage class.\footnote
{Conversely, a coarray container may not have {\tt auto} storage class.}

\item A coarray container shall not be a coarray.

\end{Constraints C}


\input{ch-co-darg}

%-------------------------------------------------------%
\section{Allocation and Deallocation of Coarrays}
\label{sec:Allocation and Deallocation of Coarrays}
%-------------------------------------------------------%

%-------------------------------------------------------%
\section{Reference and Definition to Coarrays}
\label{sec:Reference and Definition to Coarrays}
%-------------------------------------------------------%

\begin{Constraints C}
\item A coarray variable shall not be pointer-assigned.
\end{Constraints C}

%-------------------------------------------------------%
\section{Synchronization and Error Handling}
\label{sec:Synchronization and Error Handling}
%-------------------------------------------------------%

%-------------------------------------------------------%
\section{Intrinsic Procedures}
\label{sec:Intrinsic Procedures}
%-------------------------------------------------------%

%-------------------------------------------------------%
\section{Compatibility with the Fortran Standard}
\label{sec:Compatibility with the Fortran Standard}
%-------------------------------------------------------%

