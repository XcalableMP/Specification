\chapter{DRAFT: Coarray Features}
\label{chap:DRAFT: Coarray Features}

%-------------------------------------------------------%
% ENVIRONMENT 
%-------------------------------------------------------%
\newcommand{\onlyF}{{\tt [F]}} 
\newcommand{\onlyC}{{\tt [C]}} 

\newenvironment{Constraints}{\subsubsection*{Constraints}
 \begin{enumerate}}{\end{enumerate}}
\newenvironment{Constraints F}{\subsubsection*{Constraints {\onlyF}}
 \begin{enumerate}}{\end{enumerate}}
\newenvironment{Constraints C}{\subsubsection*{Constraints {\onlyC}}
 \begin{enumerate}}{\end{enumerate}}

\newenvironment{Restriction}{\subsubsection*{Restriction}
 \begin{itemize}}{\end{itemize}}

\newcommand{\NEW}[1]{\mytextcolor{red}{#1}}

%-------------------------------------------------------%
% PREFACE
%-------------------------------------------------------%

\framebox[0.9\textwidth][c]{
\rule[-5mm]{0mm}{10mm}
This chapter is a proposal document to be added before 
Section~\ref{chap:Support for the Local-view Programming}.
}

\bigskip


%-- COARRAY AS THE LOCAL-VIEW
For the local-view programming, {\XMP} supports the coarray features
as a part of the language specifications.
%-- SPECIFICATION RANGE OF THE XMP COARRAY
{\XMPF} contains all coarray features defined in the standard Fortran~2008
(ISO/IEC 1539-1:2010) with few incompatibility described in 
Section~\ref{sec:Compatibility with the Fortran Standard}
and includes some important intrinsic procedures defined in 
the standard Fortran~2015.
Also {\XMPC} contains the coarray features which was designed based on
the ones of {\XMPF}.


%-------------------------------------------------------%
\section{Introduction for Coarrays}
\label{sec:Introduction for Coarrays}
%-------------------------------------------------------%

\subsubsection*{Image and image index}
The local-view programming model is a Single Program Multiple Data (SPMD) model.
Each replication of the program is called an {\bf image}.
Every image has a different {\bf image index}, which is an integer number 
between one and the number of images.
The number of images is not determined until the program execution.

In {\XMP}, a virtual array of the whole images with any number of dimensions 
is called an {\bf image array}. 
Each array element of an image array is corresponding to an image index
in the array element order of Fortran.
The extent of the final (outermost) dimension is not determined until
the program execution because it depends on the number of images.

The images are mapped one-by-one to the execution nodes.
The correspondence between images and nodes is defined in 
Chapter~\ref{chap:Interoperability of Global- and Local-views}.
Inquire functions about the image index and the number of images 
are described in Section~\ref{sec:Intrinsic Procedures}.


\subsubsection*{Coarray}
A {\bf coarray} is an object that has an image array.
The coarray declared as a coarray with {\it coarray-spec} is
called a {\bf whole coarray}.
A subobject of a whole coarray is also regarded as a coarray under
some restrictions and has the same image array as the whole coarray.

A coarray has a {\bf corank}, {\bf cobounds} and {\bf coextents}.
A corank of a coarray is the number of dimensions of the image array.
Lower and upper cobounds and coextents of a coarray are
the upper and lower bounds and extents of the image array, respectively,
for each dimension.

{\onlyF}
A coarray has either an intrinsic type or a derived type.
A coarray is allowed to be a scalar or an array,
and allowed to be allocatable or non-allocatable.
A non-allocatable coarray must have the SAVE attribute explicitly or
implicitly; any non-allocatable and non-saved local coarray to a subprogram
is not allowed.
% example
For example, the type declaration statement shown below declares a 
two-dimensional array coarray of real type. 
The {\it coarray-spec} is the notation ``{\tt [4,0:*]}''.
The corank is 2, the lower and upper cobounds of the first dimension 
are 1 (default) and 4, and the lower cobound of the second dimension is 0.

{\onlyC}
A coarray is allowed to be a basic type, a structure type, or an array type.
In the case of an array type, the coarray is the object that the variable 
ultimately points and the name of the variable is regarded as the 
name of the coarray. 
All names of whole coarrays must have the {\tt static} or {\tt extern}
storage class specifier; any {\tt auto} coarray is not allowed.
% example
For example, the declaration shown below declares a two-dimensional array
coarray of float type. 
The {\it coarray-spec} is the notation ``{\tt [*][4]}''.
The corank is 2 and the coextents of the first dimension is 4.
Because the lower cobound is always 0, the lower and upper cobounds of 
the first dimension is 0 and 3, respectively.

\begin{center}
 \begin{minipage}{0.48\hsize}
  \begin{XFexample}
  real, save :: z(10,20)[4,0:*]
  \end{XFexample}
 \end{minipage}
%
 \begin{minipage}{0.48\hsize}
  \begin{XCexampleR}
  static float z[20][10]:[*][4];
  \end{XCexampleR}
 \end{minipage}
\end{center}


\subsubsection*{[C] Coarray Pointer}

A {\bf coarray pointer} is a pointer to a non-named coarray, which is
called a {\bf target coarray}.
A target coarray is allocated and freed with library functions
{\tt xmp\_comalloc} and {\tt xmp\_cofree}, respectively.
A coarray pointer retains the address of an allocated target coarray.
To avoid aliasing between coarrays, a coarray pointer is not allowed to 
point to any named coarrays or its subobjects,
nor to point the same target coarray or its subobjects that is pointed from
the other coarray pointer.
% example
For example, the first line of the code fragment shown below 
declares coarray pointer {\bf y} pointing to an array coarray 
of double type. 
The second line allocates a target coarray of size 
{\tt sizeof(double)*10*20} with the first-dimension coextent 4.
The third line frees the coarray and the value of {\bf y} becomes
invalid.

\begin{center}
 \begin{minipage}{0.70\hsize}
  \begin{XCexampleR}
  double (*y)[10]:[][];
  y = xmp_comalloc(sizeof(double)*10*20, 4);
  xmp_cofree(y);
  \end{XCexampleR}
 \end{minipage}
\end{center}


\subsubsection*{Coarray Container}

A non-coarray structure object can have ultimate (leaf) components as 
allocatable coarrays (in {\XMPF}) or as coarray pointers (in {\XMPC}).
The strucure object is called a {\bf coarray container} in {\XMP}.

{\onlyF} A coarray container must be a scalar, may not be a pointer
or an allocatable, may not be a coarray, and may not be a function result.

{\onlyC} A coarray container may not be a coarray and may not be a function
result.


\subsubsection*{Cosubscript}
A coarray on the different image can be referenced and defined
by referring the coarray with {\bf cosubscripts}, which
is an array element of an image array.
See Section~\ref{sec:Allocation and Deallocation of Coarrays} for the detail.


\input{ch-coarray-decl}

\input{ch-coarray-darg}

%-------------------------------------------------------%
\section{Allocation and Deallocation of Coarrays}
\label{sec:Allocation and Deallocation of Coarrays}
%-------------------------------------------------------%

%-------------------------------------------------------%
\section{Reference and Definition to Coarrays}
\label{sec:Reference and Definition to Coarrays}
%-------------------------------------------------------%

\begin{Constraints C}
\item A coarray variable shall not be pointer-assigned.
\end{Constraints C}

%-------------------------------------------------------%
\section{Synchronization and Error Handling}
\label{sec:Synchronization and Error Handling}
%-------------------------------------------------------%

%-------------------------------------------------------%
\section{Intrinsic Procedures}
\label{sec:Intrinsic Procedures}
%-------------------------------------------------------%

%-------------------------------------------------------%
\section{Compatibility with the Fortran Standard}
\label{sec:Compatibility with the Fortran Standard}
%-------------------------------------------------------%

